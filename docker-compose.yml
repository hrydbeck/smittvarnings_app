version: '3.8'
services:
  watcher:
    build:
      context: .
      dockerfile: Dockerfile.watcher
    image: mimosa-watcher:latest
    volumes:
      - ./:/work
    working_dir: /work
    # Run the watcher processes as the calling host user by default.
    # Set LOCAL_UID and LOCAL_GID in your environment (or in a .env file) to override.
    # Example: LOCAL_UID=$(id -u) LOCAL_GID=$(id -g) docker compose up
    user: "${LOCAL_UID:-1000}:${LOCAL_GID:-1000}"
    environment:
      - WATCH_DIR=/work/jasen_out
      - RESULTS_BASE=/work/intermediate_files/profiles_for_reportree

  # Optional: a stopped R service is available if you want to exec into it
  r-env:
    image: r-base:4.2.2
    command: ["sleep","infinity"]
    volumes:
      - ./:/work

  # reportree service: runs ReporTree directly inside its container. It
  # mounts the host `./intermediate_files` to `/data` and executes a small
  # watcher script that invokes reportree.py for new profile+metadata pairs.
  reportree-service:
    image: insapathogenomics/reportree:latest
    volumes:
      - ./:/work:ro
      - ./intermediate_files:/data
    # Use /data as the working directory so tools that create temporary files
    # in the CWD (e.g. GrapeTree) can write into the mounted, writable folder.
    working_dir: /data
    # Ensure reportree writes files as the host user where possible. Use the same
    # environment variables for UID/GID substitution as for the watcher.
    user: "${LOCAL_UID:-1000}:${LOCAL_GID:-1000}"
    command: ["/bin/bash", "/work/scripts/reportree_watcher.sh"]
    restart: unless-stopped
    cap_drop:
      - ALL

# Note:
# - This compose file builds a single image (watcher) that has both R and Node installed.
# - The watcher spawns Rscript locally (inside container). Reportree is run via `docker run` in
#   the included `run_reportree.js` and therefore requires Docker to be available from the host
#   or the watcher container (see comment about mounting /var/run/docker.sock above).
